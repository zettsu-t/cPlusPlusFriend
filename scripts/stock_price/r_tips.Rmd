---
title: "R tips"
author: "Zettsu Tatsuya"
date: '`r format(Sys.time(), "%Y/%m/%d")`'
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
  pdf_document:
    latex_engine: xelatex
  beamer_presentation:
    pandoc_args:
    - --latex-engine
    - xelatex
header-includes:
  \usepackage{float}
documentclass: bxjsarticle
classoption: xelatex,ja=standard
urlcolor: blue
---

```{r setup_r_packages, include=FALSE, cache=TRUE}
## knitrで使うパッケージ
library(extrafont)
library(kableExtra)
library(reticulate)
library(xfun)

output_format <- knitr::opts_knit$get("rmarkdown.pandoc.to")
output_format <- if (is.null(output_format)) {
  "html"
} else if (output_format == "gfm-yaml_metadata_block") {
  "gfm"
} else {
  output_format
}

is_html <- (output_format == "html")

get_font_or_default <- function(name) {
  font_set <- extrafont::fonts()
  if (is.null(font_set) || !(name %in% font_set)) {
    "sans"
  } else {
    name
  }
}

font_name <- get_font_or_default("Segoe UI")
font_name_jp <- get_font_or_default("Migu 1M")
```

```{r code_background_color, results="asis", eval=is_html, echo=FALSE}
cat('<style type="text/css" rel="stylesheet">\n.python { background-color: lavender }\n.r { background-color: seashell }\n.python-output { background-color: #ececec }\n.r-output { background-color: #f9f9f9 }\n</style>\n')
```

「Pythonプログラマが30分でわかるR」には載せきれないtips。

### Emacsでタグジャンプする

Emacsでソースコードを編集していて、 Alt-. を押して関数の定義に飛ぶことができる。その準備として、名前とソースコードの位置の対応表 **TAGS** ファイル を作っておく。

PythonやC++のソースコードについては etags で作る。

```{bash etags, eval=FALSE, echo=TRUE, cache=FALSE}
find . \( -name "*.py" -o -name ".cpp" \) -print | etags -L -
```

Rのソースコードについては、 Rの `rtags` 関数で作る。R以外のプログラミング言語についても TAGS を作ることができる。

```{r rtags, cache=FALSE}
suppressMessages(rtags(path = ".", pattern = "[.]*\\.(R|py|cpp)$",
  verbose = TRUE, ofile = "TAGS", append = FALSE, recursive = TRUE))
```

### 実行時間を測る

CSVファイルを読むのに、 data.table と readr のどちらが速いか測る。

```{r setup_benchmark, message=FALSE, warning=FALSE, cache=FALSE}
library(data.table)
library(tidyverse)
library(microbenchmark)
```

```{r function_benchmark, cache=FALSE}
measure_read_csv <- function(n, times) {
  df_large <- tibble(a = rnorm(n = n), b = rnorm(n = n))
  temp_filename <- tempfile(fileext = ".csv")
  on.exit(unlink(temp_filename))
  readr::write_csv(df_large, temp_filename)

  repeat_reading <- function() {
    use_data.table <- function() {
      suppressMessages(data.table::fread(temp_filename, showProgress = FALSE))
    }
    use_readr <- function() {
      suppressMessages(readr::read_csv(temp_filename, progress = FALSE))
    }

    microbenchmark::microbenchmark(use_data.table(), use_readr(), times = times,
                                   control = list(warmup = 10))
  }

  extract_method_name <- function(xs) {
    purrr::map_chr(xs, function(x) {
      stringr::str_match(x, "use_(.*)\\(\\)")[1,2]
    })
  }

  # time in nanoseconds
  repeat_reading() %>%
    as_tibble() %>%
    dplyr::mutate(expr = extract_method_name(expr)) %>%
    dplyr::mutate(time = time / 1e+9)
}
```

処理時間を violin plot で表示する。

```{r measure_benchmark, eval=TRUE, echo=FALSE, cache=FALSE}
df_result <- measure_read_csv(n = 1e+6, times = 100)
g <- ggplot(df_result, aes(x=time, y=expr, fill=expr))
g <- g + geom_violin()
g <- g + scale_fill_manual(values = c("royalblue", "navy"))
g <- g + xlim(c(0, max(df_result$time)))
g <- g + xlab("time [second]")
g <- g + ylab("package")
g <- g + theme_bw()
g <- g + theme(
  legend.position='none',
  aspect.ratio = 0.6,
  text = element_text(family = font_name),
  axis.text = element_text(family = font_name, size = 12),
  axis.title = element_text(family = font_name, size = 16),
  plot.title = element_text(family = font_name, size = 20)
)
plot(g)
```

### 絵文字を使う

emoパッケージを使うと、R Markdownに絵文字を埋め込める `r emo::ji("thumbs_up")` 。

```{r setup_emoji, message=FALSE, warning=FALSE, cache=FALSE}
# devtools::install_github("hadley/emo")
library(emo)
```

Smileに分類される絵文字の名称一覧を得て、それぞれ表示する。

```{r show_emojis, cache=FALSE}
emo::ji_keyword$smile
knitr::asis_output(purrr::map_chr(emo::ji_keyword$smile, emo::ji))
```

### clang++とC++20を使う

clang++の最新版をインストールしてから、 **~/home/rstudio/.R/Makevars** に `CXX20="clang++-12"` と書く。C++17 までは g++ などデフォルトのC++コンパイラを使う。

```{bash setup_cpp20, eval=FALSE, echo=TRUE, cache=FALSE}
sudo apt-get install -y clang-12 lldb-12 lld-12
mkdir -p /home/rstudio/.R
echo 'CXX20="clang++-12"' >> /home/rstudio/.R/Makevars
```

パッケージの **src/Makevars** に、 `CXX_STD=CXX20` と書く

```{makefile make_cpp20_package, cache=FALSE}
CXX_STD=CXX20
```

パッケージをビルドすると、C++20でコンパイルする。これで `std::popcount()` が使える。

```{r r_cpp20_package, eval=FALSE, echo=TRUE, cache=FALSE}
library(devtools)
devtools::install_local(force = TRUE)
```
