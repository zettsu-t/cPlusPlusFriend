SOURCE=fib_const.cpp

TARGET_BASE=fib_const_base
TARGET_OPT_14=fib_const_opt_14
TARGET_OPT_20=fib_const_opt_20
TARGET_BAD=fib_const_bad
TARGET_NO_OPT=fib_const_no_opt
TARGET_NO_RETURN=fib_const_no_return
TARGETS=$(TARGET_BASE) $(TARGET_OPT_14) $(TARGET_OPT_20) $(TARGET_BAD) $(TARGET_NO_OPT) $(TARGET_NO_RETURN)

ASM_EXE_BASE=fib_const_base.s
ASM_EXE_OPT_14=fib_const_opt_14.s
ASM_EXE_OPT_20=fib_const_opt_20.s
ASM_EXE_BAD=fib_const_bad.s
ASM_EXE_NO_OPT=fib_const_no_opt.s
ASM_EXE_NO_RETURN=fib_const_no_return.s
ASMS=$(ASM_EXE_BASE) $(ASM_EXE_OPT_14) $(ASM_EXE_OPT_20) $(ASM_EXE_BAD) $(ASM_EXE_NO_OPT) $(ASM_EXE_NO_RETURN)

CXX=g++
CPP_FLAGS_COMMON=-std=gnu++2a -O3 -Wall
CPPFLAGS14=-std=gnu++14 -O3 -Wall
CPPFLAGS=$(CPP_FLAGS_COMMON) -O3
CPPFLAGS_NO_OPT=$(CPP_FLAGS_COMMON) -O0
CPPFLAGS_BAD=-DBAD_ARGUMENT=-1
CPPFLAGSNO_RETURN=-DNO_RETURN
LIBPATH=
LDFLAGS=
LIBS=
TIMEOUT=timeout 10
OBJDUMP=objdump
OBJDUMP_DISASM_OPT=-d -M intel --demangle

.PHONY: all clean rebuild

all: $(TARGETS)

$(TARGET_BASE) : $(SOURCE)
	$(CXX) $(CPPFLAGS) $(LIBPATH) -DBASE -o $@ $< $(LDFLAGS) $(LIBS)
	$(OBJDUMP) $(OBJDUMP_DISASM_OPT) $@ > $(ASM_EXE_BASE)
	$(TIMEOUT) ./$@

$(TARGET_OPT_14) : $(SOURCE)
	$(CXX) $(CPPFLAGS14) $(LIBPATH) -o $@ $< $(LDFLAGS) $(LIBS)
	$(OBJDUMP) $(OBJDUMP_DISASM_OPT) $@ > $(ASM_EXE_OPT_14)
	$(TIMEOUT) ./$@

$(TARGET_OPT_20) : $(SOURCE)
	$(CXX) $(CPPFLAGS) $(LIBPATH) -o $@ $< $(LDFLAGS) $(LIBS)
	$(OBJDUMP) $(OBJDUMP_DISASM_OPT) $@ > $(ASM_EXE_OPT_20)
	$(TIMEOUT) ./$@

$(TARGET_BAD) : $(SOURCE)
	$(CXX) $(CPPFLAGS) $(CPPFLAGS_BAD) $(LIBPATH) -o $@ $< $(LDFLAGS) $(LIBS)
	$(OBJDUMP) $(OBJDUMP_DISASM_OPT) $@ > $(ASM_EXE_BAD)
	-$(TIMEOUT) ./$@

$(TARGET_NO_OPT) : $(SOURCE)
	$(CXX) $(CPPFLAGS_NO_OPT) $(CPPFLAGS_BAD) $(LIBPATH) -o $@ $< $(LDFLAGS) $(LIBS)
	$(OBJDUMP) $(OBJDUMP_DISASM_OPT) $@ > $(ASM_EXE_NO_OPT)
	-$(TIMEOUT) ./$@

$(TARGET_NO_RETURN) : $(SOURCE)
	$(CXX) $(CPPFLAGS) $(CPPFLAGSNO_RETURN) $(LIBPATH) -o $@ $< $(LDFLAGS) $(LIBS)
	$(OBJDUMP) $(OBJDUMP_DISASM_OPT) $@ > $(ASM_EXE_NO_RETURN)
	-$(TIMEOUT) ./$@

clean:
	$(RM) $(TARGETS) $(ASMS)
